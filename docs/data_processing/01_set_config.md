# Setting configuration

### Set up GRID proxy for accessing files

Ensure you have a valid GRID certificate. This is neccesary to have acces to the GRID, the distributed system used to retrieve the CERN data. If you donâ€™t have a GRID certificate, follow the instructions [here](https://twiki.cern.ch/twiki/bin/view/CMSPublic/WorkBookStartingGrid#ObtainingCert). You need to generate the certificate and export it to the `~/.globus` directory in your LXPLUS user space, which is the standard location.

This certificate cannot be used directly, you need to use a proxy. The proxy is a temporary credential derived from your certificate. Now, generate the proxy (it will ask your GRID passphrase)

```bash
voms-proxy-init --voms cms --valid 192:00 --out $HOME/.globus/x509up_u$(id -u)
```

This command created the proxy to be used with CMS data and sets its lifitime to 192 hours, if you do not specify this, it defaults to 12 hours, and 192 hours is the maximum allowed.

We store the proxy inside our home directory because it is safer and easier to use when submitting jobs. If you do not specify the output, it is stored by default in the `/tmp/` directory. The `x509up_u$(id -u)` format is a naming convention that includes your user ID.

!!! warning "Important"
    When the time expires, you must execute the command again to renew the proxy.

Now, verify that the certificate was correctly generated. First, we need to tell the system where our proxy is located, as mentioned earlier, the default directory is `/tmp/`, and the system will not find it if we saved it elsewhere. Therefore, we export the actual location

```bash
export X509_USER_PROXY=$HOME/.globus/x509up_u$(id -u)
```

The next command shows us the proxy information

```bash
voms-proxy-info --all
```

### NanoAOD datasets and branch selections

CERN has a complex data retrieval system composed of different softwares and data centers. In general, people from the experiments, *e.g.* CMS colaborators, produce data format releases that contain information recorded by the detectors or generated by Monte Carlo (MC) simulations. These releases can be in formats such as RECO, AOD, NanoAOD, etc. The format of interest for us is **NanoAOD**.

These releases are datasets. Each dataset comes from an LHC run and contains different information about the recorded or simulated events. Multiples copies of these datasets exist across different data centers in the GRID. You can find more information about the nanoAOD releases in the GitLab project [cms-nanoAOD](https://gitlab.cern.ch/cms-nanoAOD).

!!! info
    To access the gitlab repository, you must log in with your CERN account.

To locate the datasets you need, you use the **Data Aggregation System (DAS)**, it is a catalog that helps find the exact Logical File Names (LFNs) of the samples. DAS has its own query language, and the dataset paths follow a defined structure. You can find more information about DAS in [Locating Data Samples](https://twiki.cern.ch/twiki/bin/view/CMSPublic/WorkBookLocatingDataSamples).

Once you identify the actual LFN of your desired samples, you use an entry point (or redirector) in **XRootD** to reach the endpoint, the nearest datacenter from your location that hosts the samples. The data is not downloaded; instead, it is read efficiently through the XRootD protocol and accessed directly from the LXPLUS cluster. For more details, see [Using Xrootd Service (AAA) for Remote Data Access](https://twiki.cern.ch/twiki/bin/view/CMSPublic/WorkBookXrootdService). 

To use the tool, you must create a text file with the following format

!!! example "Dataset path format file"
    /Some/Das/query1/NANOAOD1.root:ID_1
    
    /Some/Das/query1/NANOAOD2.root:ID_1
    
    ...
    
    /Some/Das/query2/NANOAOD1.root:ID_2
    
    /Some/Das/query2/NANOAOD2.root:ID_2
    
    ...
    
    /Some/Das/queryn/NANOAODn.root:ID_n

Esch ROOT file is associated with an ID. Root files from the same data release share the same ID. This ID will be the target variable in the model used to classify the physical phenomenon.

!!! warning "Important"
    The IDs need to be natural numbers.

If you need help identifying your samples' FLN, refer again to [Locating Data Samples](https://twiki.cern.ch/twiki/bin/view/CMSPublic/WorkBookLocatingDataSamples). If you already know the sample FLN and want to use all root files in it, you can use the script `map_DASquery.py` as follow 

```bash
map_DASquery.py /Some/Das/query/NANOAOD1 ... /Some/Das/query/NANOAOD2 datasets_FLN_filename.txt
```


