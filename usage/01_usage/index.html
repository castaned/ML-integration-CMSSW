
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://github.com/castaned/ML-integration-CMSS/documentation/usage/01_usage/">
      
      
        <link rel="prev" href="../../framework/04_framework-setup/">
      
      
      
        
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.7.1">
    
    
      
        <title>Complete workflow - ML integration in CMSSW</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.484c7ddc.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.ab4e12ef.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Merriweather+Sans:300,300i,400,400i,700,700i%7CJetBrains+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Merriweather Sans";--md-code-font:"JetBrains Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="slate" data-md-color-primary="amber" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#complete-workflow" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="ML integration in CMSSW" class="md-header__button md-logo" aria-label="ML integration in CMSSW" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            ML integration in CMSSW
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Complete workflow
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="amber" data-md-color-accent="indigo"  aria-label="Light mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Light mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 7a5 5 0 0 1 5 5 5 5 0 0 1-5 5 5 5 0 0 1-5-5 5 5 0 0 1 5-5m0 2a3 3 0 0 0-3 3 3 3 0 0 0 3 3 3 3 0 0 0 3-3 3 3 0 0 0-3-3m0-7 2.39 3.42C13.65 5.15 12.84 5 12 5s-1.65.15-2.39.42zM3.34 7l4.16-.35A7.2 7.2 0 0 0 5.94 8.5c-.44.74-.69 1.5-.83 2.29zm.02 10 1.76-3.77a7.131 7.131 0 0 0 2.38 4.14zM20.65 7l-1.77 3.79a7.02 7.02 0 0 0-2.38-4.15zm-.01 10-4.14.36c.59-.51 1.12-1.14 1.54-1.86.42-.73.69-1.5.83-2.29zM12 22l-2.41-3.44c.74.27 1.55.44 2.41.44.82 0 1.63-.17 2.37-.44z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="amber" data-md-color-accent="indigo"  aria-label="Night mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Night mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m17.75 4.09-2.53 1.94.91 3.06-2.63-1.81-2.63 1.81.91-3.06-2.53-1.94L12.44 4l1.06-3 1.06 3zm3.5 6.91-1.64 1.25.59 1.98-1.7-1.17-1.7 1.17.59-1.98L15.75 11l2.06-.05L18.5 9l.69 1.95zm-2.28 4.95c.83-.08 1.72 1.1 1.19 1.85-.32.45-.66.87-1.08 1.27C15.17 23 8.84 23 4.94 19.07c-3.91-3.9-3.91-10.24 0-14.14.4-.4.82-.76 1.27-1.08.75-.53 1.93.36 1.85 1.19-.27 2.86.69 5.83 2.89 8.02a9.96 9.96 0 0 0 8.02 2.89m-1.64 2.02a12.08 12.08 0 0 1-7.8-3.47c-2.17-2.19-3.33-5-3.49-7.82-2.81 3.14-2.7 7.96.31 10.98 3.02 3.01 7.84 3.12 10.98.31"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="ML integration in CMSSW" class="md-nav__button md-logo" aria-label="ML integration in CMSSW" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    ML integration in CMSSW
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    
    
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_1" >
        
          
          <label class="md-nav__link" for="__nav_1" id="__nav_1_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Getting started
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_1">
            <span class="md-nav__icon md-icon"></span>
            
  
    Getting started
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../getting-started/01_overview/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Overview and objectives
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../getting-started/02_architecture/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    System architecture and workflow
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    CERN Computing Environment
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    CERN Computing Environment
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../cern-systems/01_lxplus/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    LXPLUS
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../cern-systems/02_storage/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Storage Systems
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../cern-systems/03_computing-resources/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Computational resources
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../cern-systems/04_CMSSW/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    CMSSW framework
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../cern-systems/05_GRID-authentication/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Setting up GRID proxy for data access
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../cern-systems/06-NanoAOD/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    NanoAOD format
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../cern-systems/07_dataset-discovery/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Locating and understanding CMS datasets
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Framework
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    Framework
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../framework/01_architecture/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    General architecture
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../framework/04_framework-setup/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Framework setup
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" checked>
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Example of usage
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            
  
    Example of usage
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    
  
    Complete workflow
  

    
  </span>
  
  

      </a>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              
              <article class="md-content__inner md-typeset">
                
                  



<h1 id="complete-workflow">Complete workflow</h1>
<p>This section demonstrates an end-to-end example of running the complete workflow, data processing, root into HDF5 conversion, and ML model training.</p>
<p>We assume the following:</p>
<ul>
<li>You have a LXPLUS account and a GRID certificate.</li>
<li>You already know the FLN of your datasets.</li>
<li>You have set up your CMSSW environment and are inside the <code>src/</code> directory.</li>
<li>You have your processing scripts for your specific analysis.</li>
</ul>
<p>First, clone the GitHub repository:</p>
<div class="highlight"><pre><span></span><code>git<span class="w"> </span>clone<span class="w"> </span>https://github.com/castaned/ML-integration-CMSSW<span class="w"> </span>&lt;directory_name&gt;
<span class="nb">cd</span><span class="w"> </span>&lt;directory_name&gt;
</code></pre></div>
<p>You can choose any <code>&lt;directory_name&gt;</code> you like. In this example <code>&lt;directory_name&gt;</code> will be <code>ml_framework</code>.</p>
<div class="admonition info">
<p class="admonition-title">Info</p>
<p>Remember that all example files can be found in the <code>example_files</code> directory of the repository.</p>
</div>
<p>First, we processed and convert the data. We move to the data processing directory:</p>
<div class="highlight"><pre><span></span><code><span class="nb">cd</span><span class="w"> </span>data_processing
</code></pre></div>
<p>Knowing the FLN, and having the processing script, we can process the data by modifying the YAML file <code>data_processing_config.yaml</code>:</p>
<div class="highlight"><pre><span></span><code><span class="nn">---</span>
<span class="nt">proxy</span><span class="p">:</span>
<span class="w">  </span><span class="nt">generate</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1</span><span class="w"> </span><span class="c1"># 1 yes, 0 no</span>
<span class="w">  </span><span class="nt">voms</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;cms&quot;</span>
<span class="w">  </span><span class="nt">proxy_time</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;192:00&quot;</span>
<span class="w">  </span><span class="nt">proxy_path</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;$HOME/.globus/x509up_$(id</span><span class="nv"> </span><span class="s">-u)&quot;</span>

<span class="nt">data_processing</span><span class="p">:</span>
<span class="w">  </span><span class="nt">condor_params</span><span class="p">:</span>
<span class="w">    </span><span class="nt">executable_file</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;run_filter.sh&quot;</span>
<span class="w">    </span><span class="nt">cpus</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1</span>
<span class="w">    </span><span class="nt">gpus</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0</span>
<span class="w">    </span><span class="nt">mem</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1.5GB</span>
<span class="w">    </span><span class="nt">disk</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">2GB</span>
<span class="w">    </span><span class="nt">job_flavour</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;espresso&quot;</span><span class="w"> </span><span class="c1"># 20 minutes</span>
<span class="w">  </span><span class="nt">processing_script</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;src/ml_framework/new_dataproc/example/filterNanoAOD.py&quot;</span>
<span class="w">  </span><span class="nt">eos_output_dir</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;/eos/user/v/vminjare/test_dataprocessing&quot;</span>
<span class="w">  </span><span class="nt">afs_cms_base</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;/afs/cern.ch/user/v/vminjare/CMSSW_13_3_0&quot;</span>
<span class="w">  </span><span class="nt">redirector</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;cms-xrd-global.cern.ch&quot;</span>
<span class="w">  </span><span class="nt">datasets</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">FLN</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;/ZGToLLG_01J_5f_TuneCP5_13TeV-amcatnloFXFX-pythia8/RunIISummer20UL18NanoAODv9-106X_upgrade2018_realistic_v16_L1v1-v1/NANOAODSIM&quot;</span>
<span class="w">      </span><span class="nt">ID</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0</span>
<span class="w">      </span><span class="nt">amount</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">3</span><span class="w"> </span><span class="c1"># -1 is all ROOT files</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">FLN</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;/WprimeToWZToWlepZlep_narrow_M1000_TuneCP5_13TeV-madgraph-pythia8/RunIISummer20UL18NanoAODv9-106X_upgrade2018_realistic_v16_L1v1-v1/NANOAODSIM&quot;</span>
<span class="w">      </span><span class="nt">ID</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1</span>
<span class="w">      </span><span class="nt">amount</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">-1</span>
</code></pre></div>
<div class="admonition info">
<p class="admonition-title">Info</p>
<p>Indentation in YAML files is very important, and YAML files do not accept tabs.</p>
</div>
<p>The main processing script, <code>processing_script</code>, in this case <code>filterNanoAOD.py</code>, must satisfy the following conditions:</p>
<ul>
<li>It must accept exactly the following arguments <strong>input file path</strong>, <strong>FLN</strong>, <strong>OUTPUT DIRECTORY</strong> in this order.</li>
<li>It must have a dataset labels branch taht start at 0 and increase sequentially without gaps, as the mapping declare in the <code>datasets</code> section in the YAML file.</li>
</ul>
<p>For more information, check the <a href="data-processing/somewhere">dataset processing section</a>.</p>
<p>If your GRID proxy certificate is still valid, do not generate a new one. Change <code>generate: 1</code> to <code>generate: 0</code> under the <code>proxy</code> section.</p>
<p>In this example, I have two files to process the data:</p>
<div class="highlight"><pre><span></span><code>example/
├──<span class="w"> </span>branchsel.txt
└──<span class="w"> </span>filterNanoAOD.py
</code></pre></div>
<p>In general terms, this analysis file selects events containing <strong>at least three leptons</strong> (electrons and/or muons), classifies the events into categories according to the lepton composition, and computes composite variables derived from the leptonic information.</p>
<p>These variables include the reconstructed invariant mass of the three-lepton system, the total momentum, and other kinematic quantities that allow the definition of the region of interest in the search for specific exotic particles. This procedure is performed independently for each sample, LFN in the YAML file.</p>
<p>Now we submit the jobs, one per ROOT file to process:</p>
<div class="highlight"><pre><span></span><code>python3<span class="w"> </span>execute_data_processing.py<span class="w"> </span>-f<span class="w"> </span>data_processing_config.yaml
</code></pre></div>
<p>When you execute the Python script, it first creates a tar archive of the entire <code>afs_cms_base</code> directory and uploads it to <code>eos_output_dir</code>. This step is performed locally in your current shell and may take several minutes. Once the jobs are submitted to HTCondor, you can monitor their status using <code>condor_q</code>. Also, the logs are stored in <code>logs/</code>. After all the jobs finish, the new ROOT file will be in the directory specified by <code>eos_output_dir</code>.</p>
<p>Now we convert the ROOT file into HDF5 files. First, we go to the directory:</p>
<div class="highlight"><pre><span></span><code><span class="nb">cd</span><span class="w"> </span>convert_h5
</code></pre></div>
<p>As before, configure the YAML file, for this part <code>root2h5_config.yaml</code>. For example:</p>
<div class="highlight"><pre><span></span><code><span class="nn">---</span>
<span class="nt">convertion</span><span class="p">:</span>
<span class="w">  </span><span class="nt">input_dirs</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;/eos/user/v/vminjare/test_dataprocessing/WprimeToWZToWlepZlep_narrow_M1000_TuneCP5_13TeV-madgraph-pythia8_RunIISummer20UL18NanoAODv9-106X_upgrade2018_realistic_v16_L1v1-v1_NANOAODSIM&quot;</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;/eos/user/v/vminjare/test_dataprocessing/ZGToLLG_01J_5f_TuneCP5_13TeV-amcatnloFXFX-pythia8_RunIISummer20UL18NanoAODv9-106X_upgrade2018_realistic_v16_L1v1-v1_NANOAODSIM&quot;</span>

<span class="w">  </span><span class="nt">tree_name</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;Events&quot;</span>

<span class="w">  </span><span class="nt">branches</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;all&quot;</span>

<span class="c1"># If you do not have jagged arrays leave it blank. If you use, the default value is 10</span>
<span class="w">  </span><span class="nt">max_jagged_len</span><span class="p">:</span>

<span class="w">  </span><span class="nt">eos_output_dir</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;/eos/user/v/vminjare/test_conversionh5&quot;</span>

<span class="nt">condor_params</span><span class="p">:</span>
<span class="w">  </span><span class="nt">executable_file</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;run_conversion.sh&quot;</span>
<span class="w">  </span><span class="nt">cpus</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1</span>
<span class="w">  </span><span class="nt">gpus</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0</span>
<span class="w">  </span><span class="nt">mem</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1.5GB</span>
<span class="w">  </span><span class="nt">disk</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">2GB</span>
<span class="w">  </span><span class="nt">job_flavour</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;espresso&quot;</span><span class="w"> </span><span class="c1"># 20 minutes</span>
</code></pre></div>
<p>For both conversion and training, a custom Python environment is required. We use containers for this. Before submitting the job, buil the container:</p>
<div class="highlight"><pre><span></span><code>apptainer<span class="w"> </span>build<span class="w"> </span>conversion_container.sif<span class="w"> </span>conversion_container.def
</code></pre></div>
<p>This stage needs to run some code in the current shell, which requires Python libraries not available by default. These libraries are present in the CMSSW environment, so run <code>cmsenv</code> before submitting the jobs:</p>
<div class="highlight"><pre><span></span><code>cmsenv
python3<span class="w"> </span>execute_convert_root2h5.py<span class="w"> </span>-f<span class="w"> </span>root2h5_config.yaml
</code></pre></div>
<p>When the jobs finish, your HDF5 files will be in <code>eos_output_dir</code>. If there is some problem, you can check the logs in the <code>logs/</code> directory.</p>
<p>With the processed HDF5 data, we can create, optimize, and train our ML model. Go to the training directory:</p>
<div class="highlight"><pre><span></span><code><span class="nb">cd</span><span class="w"> </span>ml_framework/ml_training
</code></pre></div>
<p>Training can be done with HTCondor, SLURM, our directly on any a server or compute.. In this example, wel run the training in LXPLUS, so we need to configure both a YAML file and a HTCondor submission file.</p>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>Note that the <code>input_paths</code> variable in the YAML configuration file does not reference EOS paths (<em>e.g.</em> <code>/eos/user/v/vminjare/</code>), as this part of the framework is not tightly coupled to CERN-specific systems. Access to EOS is instead handled through the HTCondor submission file, which ensures that the appropriate environment and filesystem access are available at runtime.</p>
</div>
<ul>
<li><code>ml_model_config.yaml</code>:</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="nn">---</span>
<span class="nt">data</span><span class="p">:</span>
<span class="w">  </span><span class="nt">input_paths</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;test_conversionh5/WprimeToWZToWlepZlep_narrow_M1000_TuneCP5_13TeV-madgraph-pythia8_RunIISummer20UL18NanoAODv9-106X_upgrade2018_realistic_v16_L1v1-v1_NANOAODSIM&quot;</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w">  </span><span class="s">&quot;test_conversionh5/ZGToLLG_01J_5f_TuneCP5_13TeV-amcatnloFXFX-pythia8_RunIISummer20UL18NanoAODv9-106X_upgrade2018_realistic_v16_L1v1-v1_NANOAODSIM&quot;</span>


<span class="w">  </span><span class="nt">output_path</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;results&quot;</span>

<span class="w">  </span><span class="nt">features</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;A_Dr_Z&quot;</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;A_Zmass&quot;</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;MET_pt&quot;</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;B_Zmass&quot;</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;B_Dr_Z&quot;</span>


<span class="w">  </span><span class="nt">label</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;Dataset_ID&quot;</span>

<span class="w">  </span><span class="nt">num_classes</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">2</span>

<span class="w">  </span><span class="c1"># Leave this blank if you do not want to apply a mapping</span>
<span class="w">  </span><span class="nt">label_mapping</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;short_name_mapping.json&quot;</span>

<span class="nt">model</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;mlp_binary_test&quot;</span>

<span class="w">  </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;mlp&quot;</span>

<span class="w">  </span><span class="nt">ideal_accuracy</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">95</span>

<span class="w">  </span><span class="nt">num_models</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">3</span>
</code></pre></div>
<ul>
<li><code>lxplus_template.jdl</code></li>
</ul>
<div class="highlight"><pre><span></span><code><span class="c1"># HTCondor Submission File</span>

<span class="l l-Scalar l-Scalar-Plain">environment = \</span>
<span class="w">    </span><span class="l l-Scalar l-Scalar-Plain">EOS_INPUT_DIR=/eos/user/v/vminjare/test_conversionh5; \</span>
<span class="w">    </span><span class="l l-Scalar l-Scalar-Plain">EOS_DIR=/eos/user/v/vminjare/outputs/$(ClusterId); \</span>
<span class="w">    </span><span class="l l-Scalar l-Scalar-Plain">REDIRECTOR=root://eosuser.cern.ch; \</span>
<span class="w">    </span><span class="l l-Scalar l-Scalar-Plain">RESULTS_DIR=results/</span>

<span class="l l-Scalar l-Scalar-Plain">#notify_user             = email@email.com</span>
<span class="l l-Scalar l-Scalar-Plain">notification            = Complete</span>
<span class="l l-Scalar l-Scalar-Plain">universe                = vanilla</span>
<span class="l l-Scalar l-Scalar-Plain">executable              = lxplus_run_template.sh</span>
<span class="l l-Scalar l-Scalar-Plain">should_transfer_files   = YES</span>
<span class="l l-Scalar l-Scalar-Plain">when_to_transfer_output = ON_EXIT</span>
<span class="l l-Scalar l-Scalar-Plain">transfer_input_files    = ./</span>
<span class="l l-Scalar l-Scalar-Plain">x509userproxy = $ENV(X509_USER_PROXY)</span>
<span class="l l-Scalar l-Scalar-Plain">output                  = job.$(ClusterId).$(ProcId).out</span>
<span class="l l-Scalar l-Scalar-Plain">error                   = job.$(ClusterId).$(ProcId).err</span>
<span class="l l-Scalar l-Scalar-Plain">log                     = job.$(ClusterId).$(ProcId).log</span>
<span class="l l-Scalar l-Scalar-Plain">request_cpus            = 5</span>
<span class="l l-Scalar l-Scalar-Plain">request_gpus            = 1</span>
<span class="l l-Scalar l-Scalar-Plain">+JobFlavour = &quot;microcentury&quot;</span>
<span class="l l-Scalar l-Scalar-Plain">queue</span>
</code></pre></div>
<p>Now build the container:</p>
<div class="highlight"><pre><span></span><code>apptainer<span class="w"> </span>build<span class="w"> </span>ml_container.sif<span class="w"> </span>ml_container.def
</code></pre></div>
<p>This may take a few minutes. Once the <code>.sif</code> file is ready, export the proxy certificate to be able to have access to XRootD:</p>
<div class="highlight"><pre><span></span><code><span class="nb">export</span><span class="w"> </span><span class="nv">X509_USER_PROXPROXY</span><span class="o">=</span>/afs/cern.ch/user/v/vminjare/.globus/x509up_u170903
</code></pre></div>
<p>Finally, submit the job:</p>
<div class="highlight"><pre><span></span><code>condor_submit<span class="w"> </span>lxplus_template.jdl
</code></pre></div>
<p>HTCondor logs will be created where we submitted the job. However, the scrpit generate its own logs files, stderr.log and stdout.log, they will be in <code>output_path/</code> along MLflow runs, plots, models files, and all result generated. If everythong went well, you will see the ROC curve and confusion matrix as follows:</p>
<div class="grid">
<figure id="fig-roc">
<p><img alt="ROC curve" src="../../assets/images/ROC_mlp_binary_test.png" width="87%" />
    <figcaption>
        Figure 3: ROC curve for the binary MLP classifier.
    </figcaption></p>
</figure>
<figure id="fig-cm">
<p><img alt="Confusion matrix" src="../../assets/images/cm_mlp_binary_test.png" width="100%" />
    <figcaption>
        Figure 4: Confusion matrix for the binary MLP classifier.
    </figcaption></p>
</figure>
</div>
<p>Finally, if you want to inspect the MLflow runs, copy <code>output_path/mlruns/</code> and the <code>ml_container.sif</code> to your computer and run:</p>
<div class="highlight"><pre><span></span><code>apptainer<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>ml_container.sif<span class="w"> </span>mlflow<span class="w"> </span>ui<span class="w"> </span>--backend-store-uri<span class="w"> </span>mlruns/<span class="w"> </span>--host<span class="w"> </span>localhost<span class="w"> </span>--port<span class="w"> </span><span class="m">8100</span>
</code></pre></div>
<p>The MLflow UI will then be available at <code>localhost:8100</code> in your web browser.</p>
<figure id="fig-mlflow">
<p><img alt="MLFlow UI" src="../../assets/images/mlflow.png" />
    <figcaption>
        Figure 1: MLFlow experiments.
    </figcaption></p>
</figure>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      
      <script id="__config" type="application/json">{"annotate": null, "base": "../..", "features": ["navigation.indexes"], "search": "../../assets/javascripts/workers/search.2c215733.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../assets/javascripts/bundle.79ae519e.min.js"></script>
      
    
  </body>
</html>